# Настройка Yandex Object Storage для асинхронного распознавания

Для использования асинхронного распознавания (до 4 часов, до 1 ГБ) нужно настроить Yandex Object Storage.

## Шаг 1: Создание статического ключа доступа

1. В консоли Yandex Cloud перейдите в раздел **Сервисные аккаунты**
2. Откройте сервисный аккаунт, созданный для проекта
3. Перейдите на вкладку **Ключи доступа**
4. Нажмите **Создать новый ключ** → **Создать статический ключ доступа**
5. Сохраните **Access Key ID** и **Secret Access Key**
   - **ВАЖНО:** Secret Access Key показывается только один раз!

## Шаг 2: Назначение роли storage.uploader

**КРИТИЧЕСКИ ВАЖНО:** Без этой роли вы получите ошибку `AccessDenied`!

1. Откройте сервисный аккаунт
2. Перейдите на вкладку **Роли**
3. Нажмите **Назначить роли**
4. Добавьте роль **Storage Uploader** (`storage.uploader`)
   - **ВАЖНО:** Роль должна быть назначена на **каталог** (folder), где находится бакет
   - Если бакет в другом каталоге, назначьте роль и там тоже
5. Нажмите **Сохранить**

**Альтернатива:** Можно использовать роль **Storage Editor** (`storage.editor`) - она дает больше прав, включая запись

## Шаг 3: Создание бакета Object Storage (если еще не создан)

1. В консоли Yandex Cloud перейдите в раздел **Object Storage**
2. Нажмите **Создать бакет**
3. Укажите имя бакета (например, `grozplex`)
4. **ВАЖНО:** Выберите **тот же каталог**, где находится сервисный аккаунт
5. Настройки доступа:
   - **Публичный доступ:** Можно оставить "Ограниченный" (SpeechKit будет использовать IAM для доступа)
   - Или установить "Публичный" для чтения объектов
6. Нажмите **Создать бакет**

**Проверка:** Убедитесь, что бакет находится в том же каталоге, что и сервисный аккаунт!

## Шаг 4: Добавление переменных окружения

Добавьте в `backend/.env`:

```env
# Настройки Object Storage для асинхронного распознавания
YANDEX_S3_BUCKET_NAME=grozplex
YANDEX_S3_ACCESS_KEY_ID=ваш_access_key_id_из_шага_1
YANDEX_S3_SECRET_ACCESS_KEY=ваш_secret_access_key_из_шага_1
YANDEX_S3_ENDPOINT=https://storage.yandexcloud.net
```

## Проверка настройки

После настройки перезапустите сервер:

```bash
cd backend
npm run start:dev
```

Система автоматически будет использовать асинхронное распознавание для длинных файлов (до 4 часов, до 1 ГБ).

## Преимущества асинхронного распознавания

- ✅ Поддержка файлов до 4 часов
- ✅ Поддержка файлов до 1 ГБ
- ✅ Более надежная обработка длинных видео
- ✅ Автоматическое удаление временных файлов из Object Storage

## Fallback на синхронное распознавание

Если асинхронное распознавание не удалось (например, из-за отсутствия настроек Object Storage), система автоматически попробует синхронное распознавание **только для файлов <= 1 МБ**.

**Важно:** Синхронное распознавание имеет лимит 1 МБ. Для файлов больше 1 МБ **обязательно** нужно настроить Object Storage.

## Устранение ошибки AccessDenied

Если вы видите ошибку `AccessDenied: Access Denied`:

1. **Проверьте переменные окружения:**
   ```bash
   # В backend/.env должны быть:
   YANDEX_S3_ACCESS_KEY_ID=ваш_ключ
   YANDEX_S3_SECRET_ACCESS_KEY=ваш_секрет
   YANDEX_S3_BUCKET_NAME=grozplex
   ```

2. **Проверьте роль сервисного аккаунта:**
   - Роль `storage.uploader` должна быть назначена на **каталог**, где находится бакет
   - Если бакет в другом каталоге, назначьте роль и там

3. **Проверьте, что бакет существует:**
   - Убедитесь, что имя бакета в `.env` совпадает с реальным именем
   - Проверьте, что бакет находится в правильном каталоге

4. **Создайте новый статический ключ:**
   - Если старый ключ не работает, создайте новый
   - Обновите переменные окружения

5. **Проверьте права на бакет:**
   - В настройках бакета убедитесь, что сервисный аккаунт имеет права на запись



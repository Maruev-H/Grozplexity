# Схема архитектуры приложения Video Analyzer

## 🏗️ Общая архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                            │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    FRONTEND (React + TypeScript)                │
│  ┌──────────────────────┐  ┌─────────────────────────────────┐  │
│  │  Загрузка файла      │  │  Ввод URL (YouTube/TikTok/IG)   │  │
│  │  или URL             │  │                                 │  │
│  └──────────┬───────────┘  └────────────┬────────────────────┘  │
│             │                           │                       │
│             └───────────┬───────────────┘                       │
│                         │                                       │
│              ┌──────────▼──────────┐                            │
│              │  Отправка запроса   │                            │
│              └──────────┬──────────┘                            │
└─────────────────────────┼───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                    BACKEND (NestJS + TypeScript)                │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │         Video Controller                                 │   │
│  │  POST /video/upload  |  POST /video/analyze-url          │   │
│  └──────────────────────┬───────────────────────────────────┘   │
│                         │                                       │
│                         ▼                                       │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              Video Service                               │   │
│  │  • Проверка длительности (до 4 часов)                    │   │
│  │  • Извлечение аудио (FFmpeg → OGG Opus)                  │   │
│  │  • Извлечение ключевых кадров (5 кадров)                 │   │
│  └──────┬───────────────────────────────────────┬───────────┘   │
│         │                                       │               │
│         │                                       │               │
│         ▼                                       ▼               │
│  ┌──────────────────┐              ┌──────────────────────┐     │
│  │  АУДИО ПУТЬ      │              │  ВИЗУАЛЬНЫЙ ПУТЬ     │     │
│  └────────┬─────────┘              └──────────┬───────────┘     │
│           │                                    │                │
│           ▼                                    ▼                │
│  ┌──────────────────┐              ┌──────────────────────┐     │
│  │ Yandex STT       │              │ Yandex Vision        │     │
│  │ Service          │              │ Service              │     │
│  │                  │              │                      │     │
│  │ • Синхронное     │              │ • Анализ кадров      │     │
│  │   (до 1 МБ)      │              │ • Текст, лица,       │     │
│  │ • Асинхронное    │              │   классификация      │     │
│  │   (до 4 часов)   │              │ • Описание кадров    │     │
│  │ • Object Storage │              └──────────┬───────────┘     │
│  └────────┬─────────┘                         │                 │
│           │                                    │                │
│           │                                    ▼                │
│           │                         ┌──────────────────────┐    │
│           │                         │ Yandex GPT Service   │    │
│           │                         │ (enhanceFrameDesc)   │    │
│           │                         └──────────┬───────────┘    │
│           │                                    │                │
│           └────────────────┬───────────────────┘                │
│                            │                                    │
│                            ▼                                    │
│              ┌───────────────────────────────┐                  │
│              │   Yandex GPT Service          │                  │
│              │   analyzeVideoContent()       │                  │
│              │                               │                  │
│              │ • Транскрипция                │                  │
│              │ • Описания кадров             │                  │
│              │ • Визуальный контекст         │                  │
│              │                               │                  │
│              │ → "Паспорт стиля"             │                  │
│              │   (структура, стиль речи,     │                  │
│              │    визуальный контекст,       │                  │
│              │    инсайты)                   │                  │
│              └──────────────┬────────────────┘                  │
│                             │                                   │
│                             ▼                                   │
│              ┌───────────────────────────────┐                  │
│              │      Результаты анализа       │                  │
│              │  • Транскрипция               │                  │
│              │  • Паспорт стиля              │                  │
│              │  • Описания кадров            │                  │
│              └──────────────┬────────────────┘                  │
└─────────────────────────────┼───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    FRONTEND (React)                             │
│              Отображение результатов анализа                    │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             │ Пользователь вводит тему
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    BACKEND (NestJS)                             │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Video Controller                                        │   │
│  │  POST /video/generate-script                             │   │
│  │  { topic, stylePassport }                                │   │
│  └──────────────────────┬───────────────────────────────────┘   │
│                         │                                       │
│                         ▼                                       │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Yandex GPT Service                                      │   │
│  │  generateScript(topic, stylePassport)                    │   │
│  │                                                          │   │
│  │  → Посекундный сценарий (60 сек)                         │   │ 
│  │  → В стиле автора                                        │   │
│  │  → С описанием кадров                                    │   │
│  └──────────────────────┬───────────────────────────────────┘   │
│                         │                                       │
│                         ▼                                       │
│              ┌──────────────────────────┐                       │
│              │   Готовый сценарий       │                       │
│              └──────────────────────────┘                       │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    FRONTEND (React)                             │
│              Отображение готового сценария                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 Детальный поток обработки видео

### Этап 1: Загрузка и подготовка
```
Пользователь
    │
    ├─→ Загружает файл ───────────────┐
    │                                 │
    └─→ Вводит URL ───────────────────┤
                                      │
                                      ▼
                            ┌─────────────────────┐
                            │  Video Controller   │
                            └──────────┬──────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │  Video Service      │
                            │  processVideo()     │
                            └──────────┬──────────┘
```

### Этап 2: Параллельная обработка
```
                            ┌─────────────────────┐
                            │  Video Service      │
                            └──────────┬──────────┘
                                       │
                    ┌──────────────────┴───────────────────┐
                    │                                      │
                    ▼                                      ▼
        ┌──────────────────────┐              ┌──────────────────────┐
        │  АУДИО ПУТЬ          │              │  ВИЗУАЛЬНЫЙ ПУТЬ     │
        │                      │              │                      │
        │ extractAudio()       │              │ extractKeyframes()   │
        │ (FFmpeg)             │              │ (FFmpeg)             │
        │                      │              │                      │
        │ → OGG Opus           │              │ → 5 кадров (PNG)     │
        └──────────┬───────────┘              └──────────┬───────────┘
                   │                                      │
                   ▼                                      ▼
        ┌──────────────────────┐              ┌──────────────────────┐
        │  Yandex STT Service  │              │  Yandex Vision       │
        │                      │              │  Service             │
        │ transcribeAudio()    │              │                      │
        │ или                  │              │ describeImage()      │
        │ transcribeAudioAsync │              │ для каждого кадра    │
        │                      │              │                      │
        │ → Транскрипция       │              │ → Описания кадров    │
        └──────────┬───────────┘              └──────────┬───────────┘
                   │                                      │
                   │                                      ▼
                   │                          ┌──────────────────────┐
                   │                          │  Yandex GPT Service  │
                   │                          │  enhanceFrameDesc()  │
                   │                          │                      │
                   │                          │ → Улучшенные         │
                   │                          │   описания кадров    │
                   │                          └───────────┬──────────┘
                   │                                      │
                   └──────────────────┬───────────────────┘
                                      │
                                      ▼
                        ┌───────────────────────────────┐
                        │  Yandex GPT Service           │
                        │  analyzeVideoContent()        │
                        │                               │
                        │  Входные данные:              │
                        │  • Транскрипция               │
                        │  • Описания кадров            │
                        │  • Визуальный контекст        │
                        │                               │
                        │  → "Паспорт стиля"            │
                        └──────────────┬────────────────┘
                                       │
                                       ▼
                        ┌─────────────────────────────┐
                        │  Результаты анализа         │
                        │  • Транскрипция             │
                        │  • Паспорт стиля            │
                        │  • Описания кадров          │
                        └──────────────┬──────────────┘
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │  Frontend           │
                            │  Отображение        │
                            └─────────────────────┘
```

### Этап 3: Генерация сценария
```
Пользователь вводит тему
    │
    ▼
┌─────────────────────┐
│  Frontend           │
│ handleGenerateScript│
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  Video Controller   │
│POST /generate-script│
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  Yandex GPT Service │
│  generateScript()   │
│                     │
│  Входные данные:    │
│  • Тема             │
│  • Паспорт стиля    │
│                     │
│  → Посекундный      │
│    сценарий (60 сек)│
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│  Frontend           │
│  Отображение        │
│  сценария           │
└─────────────────────┘
```

---

## 🔗 Интеграция с внешними сервисами

```
┌─────────────────────────────────────────────────────────────┐
│                    BACKEND (NestJS)                         │
└──────────┬──────────────┬──────────────┬────────────────────┘
           │              │              │
           ▼              ▼              ▼
┌──────────────────┐  ┌──────────────┐  ┌──────────────────┐
│  Yandex GPT API  │  │ Yandex STT   │  │ Yandex Vision    │
│                  │  │ API          │  │ API              │
│  • Анализ        │  │              │  │                  │
│  • Генерация     │  │ • Синхронное │  │ • Анализ кадров  │
│                  │  │ • Асинхронное│  │ • Описание       │
└──────────────────┘  └──────┬───────┘  └──────────────────┘
                             │
                             ▼
                    ┌──────────────────┐
                    │ Yandex Object    │
                    │ Storage (S3)     │
                    │                  │
                    │ • Временные      │
                    │   аудио файлы    │
                    └──────────────────┘
```

---

## 🐍 Python микросервис (для URL)

```
┌─────────────────────────────────────────────────────────────┐
│                    BACKEND (NestJS)                         │
│  Downloader Service                                         │
└──────────┬──────────────────────────────────────────────────┘
           │
           │ HTTP GET /download?url=...
           ▼
┌─────────────────────────────────────────────────────────────┐
│         Python Microservice (Flask)                         │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  detect_platform(url)                                │   │
│  │  → youtube | tiktok | instagram                      │   │
│  └──────────────────┬───────────────────────────────────┘   │
│                     │                                       │
│                     ▼                                       │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  download_video(url)                                 │   │
│  │  • yt-dlp скачивает видео                            │   │
│  │  • Возвращает file_path, метаданные                  │   │
│  └──────────────────┬───────────────────────────────────┘   │
│                     │                                       │
│                     ▼                                       │
│              ┌──────────────┐                               │
│              │  Видео файл  │                               │
│              └──────┬───────┘                               │
└─────────────────────┼───────────────────────────────────────┘
                      │
                      │ Возврат file_path
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                    BACKEND (NestJS)                         │
│  Video Service.processVideo()                               │
│  (далее как обычная обработка файла)                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 Компоненты системы

### Frontend
- **React + TypeScript** — UI компоненты
- **Axios** — HTTP запросы
- **State Management** — локальный state

### Backend Core
- **Video Controller** — HTTP эндпоинты
- **Video Service** — оркестрация обработки
- **Downloader Service** — прокси к Python микросервису

### AI Services
- **Yandex GPT Service** — анализ и генерация
- **Yandex STT Service** — распознавание речи
- **Yandex Vision Service** — анализ изображений
- **Yandex Storage Service** — Object Storage

### External Services
- **Yandex Cloud APIs** — GPT, STT, Vision
- **Yandex Object Storage** — S3-совместимое хранилище
- **Python Microservice** — скачивание видео (yt-dlp)

### Tools
- **FFmpeg** — обработка видео/аудио
- **Multer** — загрузка файлов

---

## 🎯 Ключевые потоки данных

1. **Загрузка файла** → Извлечение аудио/кадров → Транскрипция/Анализ → Паспорт стиля
2. **Ввод URL** → Python микросервис → Скачивание → (как загрузка файла)
3. **Генерация сценария** → Тема + Паспорт стиля → GPT → Готовый сценарий


# Настройка Yandex GPT и Speech-to-Text API

## Шаг 1: Регистрация в Yandex Cloud

1. Перейдите на https://cloud.yandex.ru/
2. Войдите или создайте аккаунт
3. Подтвердите телефон (если требуется)

## Шаг 2: Создание каталога (Folder)

1. В консоли Yandex Cloud перейдите в раздел **Каталоги**
2. Нажмите **Создать каталог**
3. Укажите имя каталога (например, `video-analyzer`)
4. **ВАЖНО:** Запомните **ID каталога** - он понадобится для `YANDEX_FOLDER_ID`
   - ID можно найти в URL или в свойствах каталога
   - Формат: `b1g1hvvrhbm972j047p1` (пример)

## Шаг 3: Создание сервисного аккаунта

1. Перейдите в раздел **Сервисные аккаунты**
2. Нажмите **Создать сервисный аккаунт**
3. Укажите имя (например, `video-analyzer-service`)
4. Выберите каталог, созданный в шаге 2
5. Нажмите **Создать**

## Шаг 4: Назначение ролей

1. Откройте созданный сервисный аккаунт
2. Перейдите на вкладку **Роли**
3. Нажмите **Назначить роли**
4. Выберите роли:
   - **AI Language Models User** (`ai.languageModels.user`) - **ОБЯЗАТЕЛЬНО** для работы с GPT
   - **SpeechKit User** (`speechkit.stt.user`) - **ОБЯЗАТЕЛЬНО** для транскрипции аудио
   - **AI Vision User** (`ai.vision.user`) - **ОБЯЗАТЕЛЬНО** для анализа изображений кадров
5. Нажмите **Сохранить**

**⚠️ КРИТИЧЕСКИ ВАЖНО:** 
- Без роли `ai.languageModels.user` вы получите ошибку **401 (Unauthorized)**!
- Роли назначаются на уровне каталога, где создан сервисный аккаунт

## Шаг 5: Создание API-ключа

1. В разделе сервисного аккаунта перейдите на вкладку **Ключи**
2. Нажмите **Создать новый ключ**
3. Выберите **API-ключ**
4. Нажмите **Создать**
5. **ВАЖНО:** Скопируйте ключ сразу - он больше не будет показан!

## Шаг 6: Настройка переменных окружения

Добавьте в `backend/.env`:

```env
YANDEX_API_KEY=ваш_api_ключ_из_шага_5
YANDEX_FOLDER_ID=ваш_id_каталога_из_шага_2
```

**Пример:**
```env
YANDEX_API_KEY=test
YANDEX_FOLDER_ID=test
```

## Шаг 7: Включение YandexGPT API

1. В консоли Yandex Cloud перейдите в раздел **API и сервисы**
2. Найдите **YandexGPT API** или **AI Language Models**
3. Убедитесь, что API включен для вашего каталога
4. Если не включен - нажмите **Включить**

## Проверка настройки

После настройки перезапустите сервер:

```bash
cd backend
npm run start:dev
```

Если все настроено правильно, вы не увидите ошибок при запуске.

## Стоимость

Yandex GPT имеет:
- **Бесплатный tier** с ограниченным количеством запросов
- **Платные планы** - см. https://cloud.yandex.ru/prices#ai-language-models

Актуальные цены смотрите на https://cloud.yandex.ru/prices

## Решение проблем

### Ошибка 401 (Unauthorized)

**Наиболее частая причина!** Проверьте:

1. **Роль сервисного аккаунта:**
   - Откройте сервисный аккаунт в Yandex Cloud
   - Перейдите на вкладку **Роли**
   - Убедитесь, что есть роль `ai.languageModels.user`
   - Если нет - добавьте её (см. Шаг 4)

2. **Правильность API-ключа:**
   - Проверьте, что `YANDEX_API_KEY` скопирован полностью
   - Убедитесь, что ключ не был удален
   - Создайте новый ключ, если нужно

3. **Правильность Folder ID:**
   - Проверьте, что `YANDEX_FOLDER_ID` - это ID каталога, а не сервисного аккаунта
   - ID каталога можно найти в URL: `https://console.cloud.yandex.ru/folders/b1g1hvvrhbm972j047p1`
   - Или в свойствах каталога

4. **Сервисный аккаунт в правильном каталоге:**
   - Сервисный аккаунт должен быть создан в том же каталоге, ID которого указан в `YANDEX_FOLDER_ID`

### Ошибка 404 (Not Found)
- Проверьте правильность `YANDEX_FOLDER_ID`
- Убедитесь, что каталог существует и доступен
- Проверьте формат: должен быть типа `b1g1hvvrhbm972j047p1`

### Ошибка 429 (Too Many Requests)
- Превышен лимит запросов
- Подождите или увеличьте лимит в настройках Yandex Cloud

### API не работает
- Убедитесь, что YandexGPT API включен для вашего каталога
- Проверьте баланс в Yandex Cloud
- Убедитесь, что сервисный аккаунт имеет необходимые права

## Дополнительная информация

- Официальная документация: https://cloud.yandex.ru/docs/ai/llm/
- API Reference: https://cloud.yandex.ru/docs/ai/llm/api-ref/
- Примеры использования: https://cloud.yandex.ru/docs/ai/llm/examples/
